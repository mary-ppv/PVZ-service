# PVZ-service
PVZ Service — это сервис для управления пунктами выдачи заказов (ПВЗ).
Проект реализован на Go с использованием PostgreSQL и SQLBoiler для ORM, поддерживает авторизацию через JWT,
логирование через slog и сбор метрик с помощью Prometheus.


# Описание

В рамках проделанной работы был разработан backend-сервис для сотрудников и модераторов пунктов выдачи заказов (ПВЗ), который позволяет управлять процессом приёмки товаров. Основные реализованные функциональные возможности включают:

1. Авторизация пользователей:
- Реализован механизм авторизации через /dummyLogin, где можно получить токен с указанием роли пользователя (employee или moderator).
- Добавлена регистрация и авторизация пользователей по почте и паролю через /register и /login. При успешной авторизации возвращается JWT-токен с уровнем доступа.
2. Создание ПВЗ:
- Только модераторы могут добавлять новые пункты выдачи заказов.
- ПВЗ можно завести только в трёх городах: Москва, Санкт-Петербург и Казань. Для других городов возвращается ошибка.
- Информация о созданном ПВЗ сохраняется в базе данных.
3. Приёмка товаров:
- Авторизованные сотрудники ПВЗ могут инициировать приёмку товаров. Если предыдущая приёмка не закрыта, создание новой невозможно.
- Результатом инициации приёмки является новая запись в базе данных.
4. Добавление товаров:
- Сотрудники ПВЗ могут добавлять товары в текущую незакрытую приёмку. Товары привязываются к последней активной приёмке в рамках конкретного ПВЗ.
- Если активной приёмки нет, возвращается ошибка.
5. Удаление товаров:
- Реализован механизм удаления товаров из текущей приёмки по принципу LIFO («последним пришёл — первым ушёл»). Удаление возможно только до закрытия приёмки.
6. Закрытие приёмки:
- Сотрудники ПВЗ могут закрывать текущую приёмку, фиксируя состав товаров. Если приёмка уже закрыта или её нет, возвращается ошибка.
7. Получение данных:
- Авторизованные пользователи (сотрудники ПВЗ или модераторы) могут получать список ПВЗ с пагинацией и фильтрацией по дате приёмки товаров.
- Данные включают информацию о ПВЗ, приёмках и товарах.

Таким образом, сервис полностью покрывает потребности в управлении приёмкой товаров на ПВЗ, обеспечивая гибкость, безопасность и удобство работы для пользователей с разными ролями.

---

##  Архитектура проекта

Проект построен по принципам **чистой архитектуры**:

```
PVZ-service/
├── cmd/                # Точка входа в приложение
├── internal/
│   ├── repository/     # Логика работы с БД через SQLBoiler
│   ├── service/        # Бизнес-логика (UserService, ProductService и т.д.)
│   ├── handler/        # HTTP-хендлеры
├── models/             # Автоматически сгенерированные SQLBoiler модели
├── pkg/
│   ├── database/       # Инициализация и подключение к БД
│   ├── logger/         # Логирование
│   ├── uuid/           # Генерация UUIDv7
│   ├── auth/           # JWT-утилиты
│   └── metrics/        # Метрики Prometheus
├── migrations/         # SQL миграции
├── sqlboiler.toml      # Конфиг для SQLBoiler
├── Dockerfile
├── docker-compose.yml
└── go.mod
```

---

##  Установка и настройка

### 1. Клонирование репозитория
```bash
git clone https://github.com/mary-ppv/PVZ-service.git cd PVZ-service
```
### 2. Установка зависимостей

```bash
go mod tidy
```

### 3. Настройка переменных окружения

Создай файл `.env`:

```env
POSTGRES_USER=postgres
POSTGRES_PASSWORD=secret
POSTGRES_DB=pvz
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
JWT_SECRET=supersecretkey
```

---

##  Запуск через Docker

```bash
docker-compose up --build
```

После запуска:

* API доступен на [`http://localhost:8080`](http://localhost:8080)
* PostgreSQL на порту `5432`
* Метрики Prometheus — на `/metrics`

---

##  Работа с БД и SQLBoiler

### 1. Генерация моделей

Перед генерацией убедись, что база данных создана и содержит нужные таблицы.

```bash
sqlboiler psql
```

Сгенерированные модели будут помещены в каталог `models/`.

---

## Пример структуры таблиц

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  role TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL
);

CREATE TABLE pvz (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  city TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL
);

CREATE TABLE receptions (
  id UUID PRIMARY KEY,
  pvz_id INTEGER REFERENCES pvz(id),
  status TEXT NOT NULL,
  product_ids JSONB DEFAULT '[]',
  date_time TIMESTAMP NOT NULL
);

CREATE TABLE products (
  id UUID PRIMARY KEY,
  reception_id UUID REFERENCES receptions(id),
  type TEXT NOT NULL,
  added_at TIMESTAMP NOT NULL
);
```

---

##  Примеры API

### POST /auth/register

Регистрация пользователя:

```json
{
  "email": "test@example.com",
  "password": "mypassword",
  "role": "employee"
}
```

### POST /auth/login

Авторизация и получение JWT:

```json
{
  "email": "test@example.com",
  "password": "mypassword"
}
```

### POST /pvz

Создание нового ПВЗ (только модератор):

```json
{
  "name": "ПВЗ №1",
  "city": "Moscow"
}
```

---

### Основные технологии

| Технология | Назначение                 |
|------------| -------------------------- |
| Go         | Основной язык проекта      |
| PostgreSQL | Основная база данных       |
| SQLBoiler  | Генерация ORM-моделей      |
| Docker     | Контейнеризация приложения |
| JWT        | Авторизация пользователей  |
| Prometheus | Метрики и мониторинг       |
| Swaggo     | Генерация Swagger-документации для REST API     |
| slog | Структурированное логирование в stdout или JSON      |

---

## Полезные команды

| Команда                                                  | Назначение           |
| -------------------------------------------------------- | -------------------- |
| `sqlboiler psql`                                         | Сгенерировать модели |
| `go run cmd/main.go`                                     | Запуск локально      |
| `docker-compose up`                                      | Запуск через Docker  |
| `migrate -path migrations -database "postgres://..." up` | Применить миграции   |

---

