# PVZ-service
Сервис для сотрудников и модераторов пунктов выдачи заказов (ПВЗ)


# Описание

В рамках проделанной работы был разработан backend-сервис для сотрудников и модераторов пунктов выдачи заказов (ПВЗ), который позволяет управлять процессом приёмки товаров. Основные реализованные функциональные возможности включают:

1. Авторизация пользователей:
- Реализован механизм авторизации через /dummyLogin, где можно получить токен с указанием роли пользователя (employee или moderator).
- Добавлена регистрация и авторизация пользователей по почте и паролю через /register и /login. При успешной авторизации возвращается JWT-токен с уровнем доступа.
2. Создание ПВЗ:
- Только модераторы могут добавлять новые пункты выдачи заказов.
- ПВЗ можно завести только в трёх городах: Москва, Санкт-Петербург и Казань. Для других городов возвращается ошибка.
- Информация о созданном ПВЗ сохраняется в базе данных.
3. Приёмка товаров:
- Авторизованные сотрудники ПВЗ могут инициировать приёмку товаров. Если предыдущая приёмка не закрыта, создание новой невозможно.
- Результатом инициации приёмки является новая запись в базе данных.
4. Добавление товаров:
- Сотрудники ПВЗ могут добавлять товары в текущую незакрытую приёмку. Товары привязываются к последней активной приёмке в рамках конкретного ПВЗ.
- Если активной приёмки нет, возвращается ошибка.
5. Удаление товаров:
- Реализован механизм удаления товаров из текущей приёмки по принципу LIFO («последним пришёл — первым ушёл»). Удаление возможно только до закрытия приёмки.
6. Закрытие приёмки:
- Сотрудники ПВЗ могут закрывать текущую приёмку, фиксируя состав товаров. Если приёмка уже закрыта или её нет, возвращается ошибка.
7. Получение данных:
- Авторизованные пользователи (сотрудники ПВЗ или модераторы) могут получать список ПВЗ с пагинацией и фильтрацией по дате приёмки товаров.
- Данные включают информацию о ПВЗ, приёмках и товарах.

Таким образом, сервис полностью покрывает потребности в управлении приёмкой товаров на ПВЗ, обеспечивая гибкость, безопасность и удобство работы для пользователей с разными ролями.

# Запуск сервиса

Для того чтобы запустить сервис, нужно выполнить следующие шаги:

1. Клонируйте мой репозиторий себе в IDE при помощи команды "git clone <URL моего репозитория>".
2. После этого на вашем компьютере появится папка с файлами проекта. Перейдите в папку и в терминале пропишите "go run .". Для остановки работы сервера в терминале введите "control + C".

Вместе с запуском сервиса у вас должен появиться файл с базой данных(которая будет изначально пуста - заполните ее по вашему усмотрению), файл с логами(обращайтесь к нему в случае появления неожиданных и непонятных ошибок). Также на сервере "localhost/9000/metrics" вы можете просматривать статистику(количество запросов, время ответа, количество созданных ПВЗ, количество созданных приёмок заказов).

UPDATE: сейчас вы можете собрать и запустить проект через Docker, выполнив следующие действия:
1. После клонирования проекта себе на компьютер соберите и запустите контейнер с помощью команды "docker compose up -d".
2. Теперь сервис запущен. Остановить можно при помощи команды "docker compose down".

# Пояснение структуры проекта

Структура проекта состоит из:
1. Папка database, которая включает файл database.go, где я создаю базу данных(в данном проекте в качестве СУБД был использован SQLite). Для удобства реализована функция clearTables, если вдруг вам захочется иметь перед собой очищенную базу данных при новом открытии.

Описание базы данных: 

1. У сущности «Пункт приёма заказов (ПВЗ)» есть:
- Уникальный идентификатор
- Дата регистрации в системе
- Город

2. У сущности «Приёмка товара» есть:
- Уникальный идентификатор
- Дата и время проведения приёмки
- ПВЗ, в котором была осуществлена приёмка
- Товары, которые были приняты в рамках данной приёмки
- Статус (in_progress, close)

3. У сущности «Товар» есть:
- Уникальный идентификатор
- Дата и время приёма товара (дата и время, когда товар был добавлен в систему в рамках приёмки товаров)
- Тип (три типа товаров: электроника, одежда, обувь)

2. Папка handlers содержит в себе функциии-обработчики и соответствующие тесты к ним.

- В файле auth.go реализован механизм авторизации через /dummyLogin, где можно получить токен с указанием роли пользователя (employee или moderator). Добавлена регистрация и авторизация пользователей по почте и паролю через /register и /login. При успешной авторизации возвращается JWT-токен с уровнем доступа. Добавлена проверка на валидность password и email.
- В файле product.go реализовано добавление товара в рамках соответствующей приёмки.
- В файле pvz.go каждый обработчик выполняет определенную функцию, связанную с созданием ПВЗ, получением списка ПВЗ, удалением последнего товара из текущей приемки и закрытием текущей приемки. 
- В файле reception.go реализовано создание приёмке в рамках определенного ПВЗ.

3. Папка middleware содержит файлы auth.go и auth_test.go.

- В файле auth.go реализована функция-обработчик, которая позволяет проверять права доступа пользователя перед выполнением запроса, записывать информацию о запросах для мониторинга и отладки, а также обеспечивать безопасность и корректность данных. - Файле auth_test.go содержит соответствующий тест к функции-обработчику, описанной выше. 

4. Папка tests содержит 2 файла: integration_test.go и logger_test.go. 

- В файле integration_test.go реализован интеграционный тест, который создает новый пвз, открывает приёмку, добавляет 50 товаров и закрывает приёмку.
- В файле logger_test.go. реализовано тестирование логгера.

5. Папка metrics включает файлы metrics.go и metrics_test.go.

- В файле metrics.go созданы метрики для подсчета количества запросов, времени ответа, количества созданных ПВЗ, количества созданных приёмок заказов.
- В файле metrics_test.go реализовано тестирование метрик.

# Примечание

- Файл с логами будет очищаться каждый раз при запуске сервера, если вам такая опция не нужна, уберите параметр "os.O_TRUNC" в функции os.OpenFile в функции создания лога.
- В случае технических неполадок, замечаний, предложений прошу обратиться ко мне в телеграмме: "mary_ppv" или по почте: "mary_ppv@mail.ru".
- В процессе разработки я сталкивалась с пакетами, которые могли бы, вероятно, оптимизировать и упростить код, например, пакет "gin" или использование mock-тестов, однако я хотела сделать сервис из пакетов, которые близки и знакомы мне.
- Тестирование сервиса я делала через Postman. Можете установить его по ссылке https://www.postman.com/downloads/.
- Вероятно, в коде может где-то встретиться повторение кода. В таком случае следует учитывать человеческий фактор.
- Каждого прочитавшего и просмотревшего мой проект прошу также оставить фидбек.
